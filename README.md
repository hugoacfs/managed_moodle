# managed_moodle
*Introduction*

This repository is a template to help manage custom Moodle installations.

It's comprised of 2 submodules, which are additional scripts which help us:
- Download core Moodle code and fix file permissions.
- Download the correct version of each additional plugin from VCT repositories.

In order to do this in an efficient way, without having to include the plugin code from all the different plugins, we use a JSON file (`plugins.json`) which contains all the required information so that `pluginmanager` (one of the submodules) can clone the repositories, and checkout the correct commit or branch to be used.

*Structure*

```
.
├── .vscode             -> Settings directory for vs code.
├── bin                 -> Scripts directory.
│   └── pluginmanager   -> Submodule for hugoacfs/pluginmanager.
├── verify              -> Hash data files directory.
└── www
    ├── html            -> Generated by release.sh script.
    ├── html-dist       -> Contains data that is used by /html/.
    └── moodledata      -> Contains language overrides etc.
```

*Usage*

To produce the latest code after developing (plugins change or core update):
1. Make sure `./plugins.json` is up to date.
2. Make sure `./bin/version.cfg` has the correct Moodle version/release.
3. Run `./bin/release.sh` script and follow instructions until the `./www/html` folder is produced.
4. Update the `./hash.json` file with the correct hash by running `php ./bin/checkhash.php`.
5. Commit changes.

To recreate without changes (for example, on dev server or live servers):
1. Make sure `./plugins.json` is up to date.
2. Make sure `./bin/version.cfg` has the correct Moodle version/release.
3. Run `./bin/release.sh` script and follow instructions until the `./www/html` folder is produced.
4. **MAKE SURE THE HASH VALUES MATCH**
5. Make a backup of your previous `/var/www/html` folder and `moodledata` folder, or snapshot the servers.
6. Rsync the `html` and `moodledata` folders using your preferred method.
7. Run one of the fix-permissions script.

## Release Shell Script
- The release script will purge caches of pluginmanager and moodle_versions.

- It will clone repositories, strip them of their git files and verify the correct versions were cloned.

- It downloads the correct Moodle release, fixes file permissions and then rsyncs everything up to an html folder, including some of the Google analytics files etc found in html-dist.

- Lastly the script will check the files are correct by hashing contents and matching against those saved in the verify folder.

*Addtional options:*
- The `-m` option can be used to save the hashed files to the verify folder, this is used when plugins are added or brough up to date.
- The `-d` option can be used to keep the git files in order to deploy a dev version, this makes it impossible to use the -m option and hashes won't be checked.
- The `-s` option skips the purging of data from pluginmanager and moodle_versions.

## Plugins JSON

Example of plugins.json:

```json
{
    "community": {
        "qbehaviour_deferredfeedbackexplain": {
            "name": "deferredfeedbackexplain",
            "path": "question/behaviour",
            "version": 2018021600,
            "repo": "https://github.com/timhunt/moodle-qbehaviour_deferredfeedbackexplain",
            "branch": "main",
            "commit": "d7f835c7acde910e759ec9cae42f63f35d466b8f"
        }
    },
    "custom": {
        "mod_mymodplugin": {
            "name": "mymodplugin",
            "path": "mod",
            "version": 2020010700,
            "repo": "git@github.com:yourusername/moodle-mod_mymodplugin.git",
            "branch": "master",
            "commit": "f5d51ded76fb098c1748fcb1d1838cec39ff2076"
        }
    }
}
```